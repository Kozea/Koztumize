{% extends "layout.html" %}

{% block head %}
<script src="http://code.jquery.com/ui/1.8.20/jquery-ui.min.js" type="text/javascript"></script>
{% if not version %}
<link href="{{ url_for('static', filename='TeddyBar/teddybar.css') }}" media="screen" type="text/css" rel="stylesheet" />
<script src="{{ url_for('static', filename='TeddyBar/teddybar.js') }}" type="text/javascript"></script>
<script>
    $(function () { 
      $('#teddybar').teddybar({
        commands : {
            'save': function() { 
                var message = '';
                if(arguments[0]) {
                  message = '/' + arguments[0];
                }
                var data = [];
                var divs = $('#iframe').contents().find('div[contenteditable]');
                $.each(divs, function () {
                    data.push({
                        "part": $(this).attr('data-part'),
                        "document_type": $(this).attr('data-document-type'),
                        "document_id": $(this).attr('data-document-id'),
                        "version": $(this).attr('data-document-version'),
                        "content": $(this).html()
                    });
                });
                var tables = $('#iframe').contents().find('div[data-content]');
                $.each(tables, function () {
                    var spans = $(this).find('span[contenteditable]');
                    var values = [];
                    $.each(spans, function () {
                         values.push($(this).html());
                    })
                    data.push({
                        "part": $(this).attr('data-part'),
                        "document_type": $(this).attr('data-document-type'),
                        "document_id": $(this).attr('data-document-id'),
                        "version": $(this).attr('data-document-version'),
                        "content": JSON.stringify(values)
                    });
                });
                // Make ajax
	            $.ajax({
		            url: "{{ url_for('save', document_type=document_type) }}" + message,
		            data: JSON.stringify(data),
		            contentType: 'application/json',
		            dataType: 'json',
		            type: "POST",
		            success: function(response){
		                if(response && response.documents) {
                            var message = 'Contenu enregistré.';
                            var div = $('<div>', {'class': 'ok'}).html(message);
                            $('body>section').before(div);
                            div.slideDown(300).delay(3000).fadeOut();
                            $.each(response.documents, function () {
                                var divs = $('#iframe').contents().find(
                                    'div[contenteditable]' +
                                    '[data-document-type="' + this.document_type + '"]' +
                                    '[data-document-id="' + this.document_id + '"]'
                                );
                                divs.attr('data-document-version', this.version);
                            });
                        } else {
                            var message = 'Conflit: Veuillez rafraîchir la page.';
                            var div = $('<div>', {'class': 'error'}).html(message);
                            $('body>section').before(div);
                            div.slideDown(300).delay(3000).fadeOut();
                        }            
                    }
	            });			
	        },
	        'save_as': function () {
	          var message = prompt('Message:');
	          if(message==null) {
	            return false;
	          } else if(message.length==0) {
	            if(confirm('Vous n\'avez pas spécifié de message, continuer ?')) {
	              this.save();
	            } else {
							  return false;
							}
	          } else {
	            this.save(message);
	          }
	        },
	        'pdf': function() {
	            var loader = $('<div>', {'class': 'loading'});
	            loader.fadeIn(500);
	            
	            $.ajax({
		            url:"{{ url_for('pdf_link', document_type=document_type, document_name=document_name) }}",
		            success: function(response){
			            $('#loader').hide();
			            window.location=response;
		            }
	            });
            },
            'settings': function () {
	          $('#settings').toggle();
	          
	        },
	        'pdf': function() {
	            var loader = $('<div>', {'class': 'loading'});
	            loader.fadeIn(500);
	            
	            $.ajax({
		            url:"{{ url_for('pdf_link', document_type=document_type, document_name=document_name) }}",
		            success: function(response){
			            $('#loader').hide();
			            window.location=response;
		            }
	            });
            }
        }
      });
		  $( "#settings" ).draggable();
		  $('.add-people').click(function () {
		    $('#users').toggle(200);
		  });
		  $('#users').find('input[type=button]').click(function() {
		      if($('input[name=r]').is(':checked') === false && $('input[name=w]').is(':checked') === false) {
		        alert('Veuillez cocher au moins 1 case');
		        return false;
		      }
		      $.ajax({
		          url: "{{ url_for('create_rights') }}",
		          type: 'post',
		          data: {
		              'document_id': "{{ document_name }}",
		              'user_id': $('select[name=user]').val(),
		              'read': $('input[name=r]').is(':checked'),
		              'write': $('input[name=w]').is(':checked')  
		          },
		          success: function(user) {
		              rights = 'Lecture';
		              if(user.write == 'true') {
		                  rights = 'Lecture et Ecriture';
		              }
		              row = '<tr data-user="' + user.user_id + '"><td>' + user.user_id + '</td><td class="rights"><a href="modify_rights">' + rights + '</a></td><td><a href="javascript:delete_rights(\'' + user.user_id + '\')">x</a></td></tr>';
		              $('#allowed-users').append(row);
		              $('select[name=user]').find('option[value="' + user.user_id + '"]').remove();
		              if($('select[name=user]').find('option').length == 0) {
		                  $('#users, .add-people').remove();
		              }
		          }
		      });
		  });
		  if($('select[name=user]').find('option').length == 0) {
          $('#users, .add-people').remove();
      }
      $('
    });
    function delete_rights(user_id) {
        $.ajax({
            url: "{{ url_for('delete_rights') }}",
            type: 'post',
            data: {
                'document_id': "{{ document_name }}",
                'user_id': user_id,
            },
            success: function(user_id) {
              $('#allowed-users').find('tr[data-user="' + user_id + '"]').remove();
              option = $('<option>', {'value': user_id}).html(user_id);
              $('select[name=user]').append(option);
            }
        });
    }
</script>
{% else %}
<style>
.definition:empty:before {
  display: none;
}

</style>
<script>
    function callIframe(callback) {
        var iframe = $('<iframe>', {
            'id': 'iframe',
            'src': '{{ url_for("model", document_type=document_type, document_name=document_name, version=version) }}'
        });
        $(document.body).find('h2+ul').after(iframe);

        $('#iframe').load(function(){
            $('iframe').contents().find('*[contenteditable]').removeAttr("contenteditable");
            $('iframe').contents().find('input[type=button]').remove();
        });
    }
    
    $(document).ready(function() { 
        callIframe();
    });
</script>
{% endif %}
{% endblock head %}

{% block content %}
  <div id="teddybar"></div>
  <h2>{{ document_type }}/{{ document_name }}</h2>
  {% if version %}
    <ul class="options">
      <li><a href="{{ url_for('pdf', document_type=document_type, document_name=document_name, version=version) }}">Télécharger en PDF</a></li>
      <li><a href="{{ url_for('edit', document_type=document_type, document_name=document_name) }}">Accéder à la dernière version</a></li>
    </ul>
  {% else %}
    <iframe id="iframe" src="{{ url_for('model', document_type=document_type, document_name=document_name, version=version) }}"></iframe>

    <div id="settings">
      <div>Qui a accès</div>
      <table id="allowed-users">
        <tbody>
        {% for allowed_user in allowed_users %}
          <tr data-user="{{allowed_user}}">
            <td {% if allowed_user.user_id == owner %} id="owner" {% endif %}>{{ allowed_user.user_id }}</td>
            {% if allowed_user.user_id == owner %}
              <td class="rights">Propriétaire</td>
            {% elif allowed_user.read and not allowed_user.write %}            
              <td class="rights">
              {% if session.get('user') == owner %}
                <a class="update-people" href="javascript:" onclick="update_rights('{{ allowed_user.user_id }}')">Lecture</a>
              {% else %}
                Lecture
              {% endif %}
              </td>
            {% else %}
              <td class="rights">
              {% if session.get('user') == owner %}
                <a href="modify_rights">Lecture et Ecriture</a>
              {% else %}
                Lecture et Ecriture
              {% endif %}
              </td>
            {% endif %} 
            {% if session.get('user') == owner and not allowed_user.user_id == owner%} 
              <td>
                <a class="delete-people" href="javascript:" onclick="delete_rights('{{ allowed_user.user_id }}');">x</a>
              </td> 
            {% else %}
              <td></td>
            {% endif %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% if session.get('user') == owner %}
        <button class="add-people"></button>
        <form method="post" id="users">
          <select name="user">
          {% for user in c %}
            <option value="{{ user }}">{{ user }}</option>
          {% endfor %}
          </select>
          <input type="checkbox" name="r" id="check-read"><label for="check-read">Lecture</label>
          <input type="checkbox" name="w" id="check-write"><label for="check-write">Ecriture</label>
          <input type="button" value="Valider">
        </form>
      {% endif %}
    </div>
  {% endif %}
{% endblock content %}

